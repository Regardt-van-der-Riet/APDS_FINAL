version: 2.1

# Define reusable executors
executors:
  node-executor:
    docker:
      - image: cimg/node:18.17.0
    working_directory: ~/project

# Define reusable commands
commands:
  install-dependencies:
    description: "Install Node.js dependencies"
    parameters:
      directory:
        type: string
        default: "."
    steps:
      - run:
          name: Install dependencies in << parameters.directory >>
          command: |
            cd << parameters.directory >>
            npm ci

# Define jobs
jobs:
  # Security checks job
  security-check:
    executor: node-executor
    steps:
      - checkout
      - run:
          name: Install npm-audit
          command: npm install -g npm-audit-resolver
      - install-dependencies:
          directory: "backend"
      - run:
          name: Run npm audit on backend
          command: |
            cd backend
            npm audit --audit-level=moderate || true
      - install-dependencies:
          directory: "frontend"
      - run:
          name: Run npm audit on frontend
          command: |
            cd frontend
            npm audit --audit-level=moderate || true
      - run:
          name: Check for vulnerable packages
          command: |
            echo "Security audit completed. Review any vulnerabilities above."

  # Backend build and test job
  backend-build-test:
    executor: node-executor
    steps:
      - checkout
      - install-dependencies:
          directory: "backend"
      - run:
          name: Lint backend code
          command: |
            cd backend
            echo "Linting backend code..."
            # Add linting command when configured
      - run:
          name: Run backend tests
          command: |
            cd backend
            echo "Running backend tests..."
            # npm test when tests are implemented
      - run:
          name: Build backend
          command: |
            cd backend
            echo "Backend build successful"

  # Frontend build and test job
  frontend-build-test:
    executor: node-executor
    steps:
      - checkout
      - install-dependencies:
          directory: "frontend"
      - run:
          name: Lint frontend code
          command: |
            cd frontend
            echo "Linting frontend code..."
            # Add linting command when configured
      - run:
          name: Run frontend tests
          command: |
            cd frontend
            echo "Running frontend tests..."
            # npm test when tests are implemented
      - run:
          name: Build frontend for production
          command: |
            cd frontend
            npm run build
      - persist_to_workspace:
          root: ~/project
          paths:
            - frontend/build

  # Code quality and SAST (Static Application Security Testing)
  code-quality:
    docker:
      - image: cimg/node:18.17.0
    working_directory: ~/project
    steps:
      - checkout
      - install-dependencies:
          directory: "backend"
      - install-dependencies:
          directory: "frontend"
      - run:
          name: Install SonarQube Scanner
          command: |
            # Download and install SonarScanner
            wget -q https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-5.0.1.3006-linux.zip
            unzip -q sonar-scanner-cli-5.0.1.3006-linux.zip
            sudo mv sonar-scanner-5.0.1.3006-linux /opt/sonar-scanner
            sudo ln -s /opt/sonar-scanner/bin/sonar-scanner /usr/local/bin/sonar-scanner
      - run:
          name: Run SonarQube Analysis
          command: |
            # Run SonarQube scan
            sonar-scanner \
              -Dsonar.projectKey=${SONAR_PROJECT_KEY} \
              -Dsonar.organization=${SONAR_ORGANIZATION} \
              -Dsonar.host.url=https://sonarcloud.io \
              -Dsonar.login=${SONAR_TOKEN}
      - run:
          name: Check Quality Gate
          command: |
            echo "SonarQube analysis completed!"
            echo "Check results at: https://sonarcloud.io/dashboard?id=${SONAR_PROJECT_KEY}"

  # Dependency check
  dependency-check:
    executor: node-executor
    steps:
      - checkout
      - run:
          name: Check for outdated dependencies
          command: |
            echo "Checking for outdated dependencies..."
            cd backend && npm outdated || true
            cd ../frontend && npm outdated || true

  # SSL certificate validation
  ssl-validation:
    executor: node-executor
    steps:
      - checkout
      - run:
          name: Validate SSL configuration
          command: |
            echo "Validating SSL configuration..."
            echo "Ensure SSL certificates are properly configured for production"

# Define workflows
workflows:
  version: 2
  
  # Main DevSecOps pipeline
  build-test-deploy:
    jobs:
      # Security checks run first
      - security-check
      
      # Code quality checks
      - code-quality:
          requires:
            - security-check
      
      # Dependency checks
      - dependency-check:
          requires:
            - security-check
      
      # Backend pipeline
      - backend-build-test:
          requires:
            - security-check
      
      # Frontend pipeline
      - frontend-build-test:
          requires:
            - security-check
      
      # SSL validation
      - ssl-validation:
          requires:
            - backend-build-test
            - frontend-build-test

  # Nightly security scan
  nightly-security:
    triggers:
      - schedule:
          cron: "0 0 * * *"
          filters:
            branches:
              only:
                - main
                - master
    jobs:
      - security-check
      - dependency-check

